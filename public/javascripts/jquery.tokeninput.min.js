!function(e){var t,n,a,o,i={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},s={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},l={BEFORE:0,AFTER:1,END:2};if(KeyboardEvent.prototype.hasOwnProperty("key")){var r=!0;o={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}}else o={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188},Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}});r&&(n=Object.getOwnPropertyDescriptor(t=KeyboardEvent.prototype,"key"),a={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete"},Object.defineProperty(t,"key",{configurable:!0,enumerable:!0,get:function(){var e=n.get.call(this);return a.hasOwnProperty(e)?a[e]:e}})),e.fn.tokenInput=function(t,n){var a=e.extend({},i,n||{});return this.each(function(){new e.TokenList(this,t,a)})},e.TokenList=function(t,n,a){"string"==typeof n?(a.url=n,void 0===a.crossDomain&&(-1===a.url.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1])):"object"==typeof n&&(a.local_data=n),a.classes?a.classes=e.extend({},s,a.classes):a.theme?(a.classes={},e.each(s,function(e,t){a.classes[e]=t+"-"+a.theme})):a.classes=s;var i,r=[],c=0,u=new e.TokenList.Cache,d=e(t).attr("id");e('label[for="'+d+'"]').attr({for:d+"_autocomplete"});var p=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:d+"_autocomplete"}).focus(function(){(null===a.tokenLimit||c<a.tokenLimit)&&(e(this).val().length>=a.minChars?setTimeout(function(){F()},5):a.hintText&&(E.html("<p class='notice'>"+a.hintText+"</p>"),x()))}).blur(function(){L()}).keydown(function(t){switch(t.key){case o.LEFT:case o.RIGHT:case o.UP:case o.DOWN:if(!k||k.is(":hidden"))h?(n=e(h).prev(),i=e(h).next(),t.key===o.LEFT||t.key===o.UP?w(e(h),l.BEFORE):w(e(h),l.AFTER)):(n=T.prev(),i=T.next()),(t.key===o.LEFT||t.key===o.UP)&&n.length?P(e(n.get(0))):(t.key===o.RIGHT||t.key===o.DOWN)&&i.length&&P(e(i.get(0)));else{if(t.key===o.LEFT||t.key===o.RIGHT)return!0;var n,i,s=null;return(s=v?t.key===o.DOWN?e(v).next():e(v).prev():k).length?(b(s),e(E).scrollTo(e(s))):t.key===o.UP&&v&&N(e(v)),!1}break;case o.BACKSPACE:case o.DELETE:if(n=T.prev(),!e(this).val().length)return h?_(e(h)):n.length&&P(e(n.get(0))),!1;1===e(this).val().length?L():setTimeout(function(){F()},25);break;case o.COMMA:case o.TAB:case o.ENTER:case o.NUMPAD_ENTER:if(v){if(A(e(v)),N(e(v)),L(),t.keyCode!==o.TAB||!a.tokenLimit||a.tokenLimit!==c)return!1}else if(p.val()&&(e.each(p.val().split(a.tokenDelimiter),function(t,n){A(e.trim(n))}),L(),t.keyCode!==o.TAB||!a.tokenLimit||a.tokenLimit!==c))return!1;break;case o.ESCAPE:return L(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){F()},25)}});e(t).closest("form").submit(function(){p.val()&&e.each(p.val().split(a.tokenDelimiter),function(t,n){A(e.trim(n))})});var f=e(t).hide().focus(function(){p.focus()}).blur(function(){p.blur()}),h=null,m=0,v=null,k=null,g=e("<ul />").addClass(a.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?function t(n){var a,o,i=h;if(h){if(h===n.get(0)){a=n,L(),o=e.data(a.get(0),"tokeninput"),_(a),p.val(o.id);return}w(e(h),l.END)}i===n.get(0)?w(n,l.END):P(n)}(n):(h&&w(e(h),l.END),p.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&h!==this&&n.addClass(a.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&h!==this&&n.removeClass(a.classes.highlightedToken)}).insertBefore(f);a.makeSortable&&g.addClass(a.classes.sortable);var T=e("<li />").addClass(a.classes.inputToken).appendTo(g).append(p),E=e("<div>").addClass(a.classes.dropdown).insertAfter(p).hide(),C=e(t).val()||a.prePopulate;if(a.processPrePopulate&&e.isFunction(a.onResult)&&(C=a.onResult.call(f,C)),e(t).val(""),f.val(""),p.val(""),C&&C.length&&("string"==typeof C?y(C,C):e.each(C,function(e,t){y(t.id,t.name)})),null!==a.tokenLimit&&c>=a.tokenLimit&&p.hide(),a.liveParams){var D=a.liveParams.split("&");e.each(D,function(t,n){var a=n.split("="),o="#"+a[1]+" input";0===e(o).length&&(o="#"+a[1]),e(o).each(function(t,n){e(n).hasClass("autocomplete")&&(n=e(n).prev().find("input").first()),e(n).change(function(e){u.clear_data()})})})}function $(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function y(t,n){if(n.indexOf(a.tokenDelimiter)>=0){e.each(n.split(a.tokenDelimiter),function(e,t){y(t,t)});return}var o=e("<li>"+O(n)+" </li>").addClass(a.classes.token).insertBefore(T);a.makeSortable;var i=e("<span></span>").addClass(a.classes.tokenDelete).appendTo(o).click(function(){return _(e(this).parent()),!1});e('<a href="#">'+a.deleteText+"</a>").attr("title","remove "+n).appendTo(i);var s={id:t,name:n};e.data(o.get(0),"tokeninput",s),r=r.slice(0,m).concat([s]).concat(r.slice(m)),m++;var l=e.map(r,function(e){return e.id});return f.val(l.join(a.tokenDelimiter)),c+=1,o}function A(t){n="string"===e.type(t)?{id:t,name:t}:e.data(t.get(0),"tokeninput"),p.val("");var n,o=a.onAdd;if(c>0&&a.preventDuplicates){var i=null;if(g.children().each(function(){var t=e(this),a=e.data(t.get(0),"tokeninput");if(a&&a.id===n.id)return i=t,!1}),i){P(i),p.focus();return}}y(n.id,n.name),null!==a.tokenLimit&&c>=a.tokenLimit?(p.parent().prev("li").find("a").focus(),p.hide()):p.focus(),L(),e.isFunction(o)&&o.call(f,n),p.change()}function P(e){e.addClass(a.classes.selectedToken),h=e.get(0),p.val(""),L()}function w(e,t){e.removeClass(a.classes.selectedToken),h=null,t===l.BEFORE?m--:t===l.AFTER?m++:m=c,p.focus()}function _(t){var n=e.data(t.get(0),"tokeninput"),o=a.onDelete,i=t.prevAll().length;i>m&&i--,t.remove(),h=null,p.focus(),r=r.slice(0,i).concat(r.slice(i+1)),i<m&&m--;var s=e.map(r,function(e){return e.id});f.val(s.join(a.tokenDelimiter)),c-=1,null!==a.tokenLimit&&p.show().val("").focus(),e.isFunction(o)&&o.call(f,n),p.change()}function L(){E.hide(),v&&e(v).removeClass(a.classes.selectedToken),v=null}function x(){E.css({position:"absolute"}).css("z-index",999).show()}function R(t,n){if(n&&n.length){E.empty();var o=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(E).mouseover(function(t){b(e(t.target).closest("li"))}).mousedown(function(t){return A(e(t.target).closest("li")),!1}).hide();e.each(n,function(n,i){var s,l,r,c=e('<li role="option">'+(s=O(i.name),l=t,r=s,e.each(l.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),r=r.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),r)+"</li>").appendTo(o);n%2?c.addClass(a.classes.dropdownItem):c.addClass(a.classes.dropdownItem2),0===n&&(k=c),e.data(c.get(0),"tokeninput",{id:i.id,name:i.name})}),x(),a.animateDropdown?o.slideDown("fast"):o.show()}else a.noResultsText&&(E.html("<p class='notice'>"+a.noResultsText+"</p>"),x())}function b(t){t&&(v&&N(e(v)),t.addClass(a.classes.selectedDropdownItem),v=t.get(0))}function N(e){e.removeClass(a.classes.selectedDropdownItem),v=null}function O(t){return a.escapeHTML?e("<p></p>").text(t).html():t}function F(){var t=p.val().toLowerCase();(t&&t.length||0==a.minChars)&&(v&&N(e(v)),h&&w(e(h),l.AFTER),0==a.minChars||t.length>=a.minChars?(a.searchingText&&(E.html("<p class='notice'>"+a.searchingText+"</p>"),x()),clearTimeout(i),i=setTimeout(function(){(function t(n){if(!a.noCache)var o=u.get(n);!a.noCache&&o?R(n,o):function t(n){if(a.url)(function t(n){var o={};if(o.data={},a.url.indexOf("?")>-1){var i=a.url.split("?");o.url=i[0];var s=i[1].split("&");e.each(s,function(e,t){var n=t.split("=");o.data[n[0]]=n[1]})}else o.url=a.url;if(a.liveParams){var l=a.liveParams.split("&");e.each(l,function(t,n){var a=n.split("="),i="#"+a[1]+" input";0===e(i).length?i="#"+a[1]:i+=":checked";var s=e(i).map(function(t,n){return e(n).val()}).get();s&&(o.data[a[0]]=s)})}o.data[a.queryParam]=n,o.type=a.method,o.dataType=a.contentType,a.crossDomain&&(o.dataType="jsonp"),o.success=function(t){e.isFunction(a.onResult)&&(t=a.onResult.call(f,t)),a.noCache||u.add(n,a.jsonContainer?t[a.jsonContainer]:t),p.val().toLowerCase()===n&&p.is(":focus")&&R(n,a.jsonContainer?t[a.jsonContainer]:t)},e.ajax(o)})(n);else if(a.local_data){var o=e.grep(a.local_data,function(e){return e.name.toLowerCase().indexOf(n.toLowerCase())>-1});e.isFunction(a.onResult)&&(o=a.onResult.call(f,o)),u.add(n,o),R(n,o)}}(n)})(t)},a.searchDelay)):L())}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),a={},o=0,i=function(){a={},o=0};this.clear_data=function(){i()},this.add=function(e,t){o>n.max_size&&i(),a[e]||(o+=1),a[e]=t},this.get=function(e){return a[e]}}}(jQuery);